---
layout: default
title: Manuscript
---
<h3>Introduction</h3>
In this session we will create an app where the user can search for a Spotify track, and play the found track on a device. Remember to have
an updated version of Android Studio

<h3>Main</h3>
<ol>
	<li>Open Android Studio, create an empty project.</li>
	<li>Explain Activities (<a href="android-app-structure-and-components.html"> App Structure And Components</a>)</li>
	<li>Run Hello World app and explain debugging.</li>
	<li>Explain layouts and layout controls (<a href="common-view-controls.html"> Common View Controls)</a>)</li>
	<li>Explain the UI builder</li>
	<li>Create the MainActivity for the Spotify app. MainActivity will display an input text field and a button. </li>
    <li>Create the layout files and controls for the activity.</li>
    <li>Setup search and explain AsyncTasks (<a href="working-in-the-background.html"> Working In the Background).</a>
    	Print a simple text in <code>doInBackground()</code> to illustrate background work</li>
	<li>Add classes for network communication. We use the Apache HTTP client. Skip live coding this part.</li>
	<li>Add Gradle dependencies for JSON parsing and explain why we need this:
		<p><code>compile 'com.fasterxml.jackson.core:jackson-core:2.4.1.3'</code></p>
   		<p><code>compile 'com.fasterxml.jackson.core:jackson-databind:2.4.1.3'</code> </p>
	</li>
	<li>Replace content in <code>doInBackground()</code> with search method from SearchService. Add a <code>Toast</code> in <code>onPostExecute()</code>
		which will display the first track result. This illustrates that a network call actually was performed</li>
	<li>Do not add internet permission until app has run and failed. Explain the Android Manifest and the need for permissions</li> 
	{% highlight xml %}
	    <uses-permission android:name="android.permission.INTERNET" />
	{% endhighlight %}
	<li>Run app again and see that the <code>Toast</code> pops up.</li>
	<li>Create the ResultActivity. ResultActivity will display a list containing the search results. Add entries to the Android Manifest</li>
	<li>
    <li>Remove <code>Toast</code> and start the ResultActivity from the <code>onPostExecute()</code>using Intents. Explain that there are several ways to pass
    	objects between activities, for instance Parcelable. For simplicity, we use Jackson to serialize the search result as a String and pass this as a <code>
    	stringExtra</code></li>
    <li>In the ResultActivity, parse the String as Track domain objects using Jackson</li>
    <li>Add and explain custom ListAdapters (<a href="list-list-adapters.html"> Lists and List Adapters)</a></li>
    <li>Populate the ListAdapter fields with properties from the Track domain objects</li>
    <li>Add a click handler for each list element, where clicks will start Spotify and play song</li>
</ol>


<h3> Result Dto, AsyncTask and SearchService</h3>

Create the <b>Result</b> Dto object, which will contain a list of tracks
{% highlight java %}
@JsonIgnoreProperties(ignoreUnknown = true)
public class Result {
    private List<Track> tracks;

    public List<Track> getTracks() {
        return tracks;
    }

    public void setTracks(List<Track> tracks) {
        this.tracks = tracks;
    }
}

	{% endhighlight %}

	Create an <b>AsyncTask</b> for performing the web request
	{% highlight java %}
private class TrackSearchAsyncTask extends AsyncTask<String, Void, Result> {
	private SearchService searchService;

	@Override
	protected void onPreExecute() {
		searchService = new SearchService();
		super.onPreExecute();
	}

	@Override
	protected Result doInBackground(String ...params) {
		// Perform search for tracks in Spotify
		return searchService.searchForTrack(params[0]);
	}

	@Override
	protected void onPostExecute(Result result) {
		ArrayList<Track> tracks = new ArrayList<Track>();
		tracks.addAll(result.getTracks());

		// Start result activity which displays the result.
		Intent resultActivity = new Intent(getApplicationContext(), ResultActivity.class);
		// Add the search result as a String
		ObjectMapper mapper = new ObjectMapper();
		try {
		String listAsString = mapper.writeValueAsString(tracks);
		resultActivity.putExtra("tracks", listAsString);
		startActivity(resultActivity);
		} catch (JsonProcessingException e) {
		// Do nothing
		}
	}
}
{% endhighlight %}


<b>SearchService</b> to be used in AsyncTask
{% highlight java %}
public class SearchService {
    private static final String TAG = "SearchService";

    public Result searchForTrack(String trackName) {
        HttpClient httpClient = new HttpClient();
        JsonParser jsonParser = new JsonParser();
        Result result = new Result();
        try {
            result = jsonParser.parseTrackResponse(httpClient.getTracks(trackName));
        } catch (IOException e) {
            Log.e(TAG, "Could not parse json");
            e.printStackTrace();
        }
        return result;
    }
}
{% endhighlight %}


<h3> Classes and Services</h3>
<b>HttpClient</b>
{% highlight java %}
	public class HttpClient {
    private static final String TRACK_SEARCH_URL = "http://ws.spotify.com/search/1/track.json?q=";

    /*
        Method which uses the built-in Apache HTTP client
     */
    public String getTracks(String trackName) {
        trackName = trackName.replace(" ", "%20");
        String trackSearchQueryWithArg = TRACK_SEARCH_URL + trackName;
        DefaultHttpClient defaultHttpClient = new DefaultHttpClient();
        String result = "";
        InputStream data = null;
        BufferedReader reader = null;
        try {
            HttpGet method = new HttpGet(new URI(trackSearchQueryWithArg));
            HttpResponse response = defaultHttpClient.execute(method);
            data = response.getEntity().getContent();
            reader = new BufferedReader(new InputStreamReader(data, "UTF-8"));
            StringBuilder builder = new StringBuilder();
            for (String line; (line = reader.readLine()) != null;) {
                builder.append(line).append("\n");
            }
            result = builder.toString();
        }
        catch (Exception e) {
            System.out.println(e);
        }
        finally {
            try {
                if (data != null) {
                    data.close();
                }
                if (reader != null) {
                    reader.close();
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return result;
    }
}
 	{% endhighlight %}


<b>Track</b> domain object

{% highlight java %}
@JsonIgnoreProperties(ignoreUnknown = true)
public class Track {
	private String name;
	private List<Artist> artists;
	private String href;

	// Jackson needs an empty constructor
	public Track() {
	}

	public String getHref() {
		return href;
	}

	public void setHref(String href) {
		this.href = href;
	}

	public List<Artist> getArtists() {
		return artists;
	}

	public void setArtists(List<Artist> artists) {
		this.artists = artists;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}
}
{% endhighlight %}

<b>Artist</b> domain object
{% highlight java %}
@JsonIgnoreProperties(ignoreUnknown = true)
public class Artist {
	private String name;

	// Jackson needs an empty constructor
	public Artist() {
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}
}
{% endhighlight %}


<h3>ListAdapter</h3>
List adapter for displaying the search results
{% highlight java %}

public class TrackAdapter extends ArrayAdapter {
	
	private LayoutInflater inflater;

	public TrackAdapter(Context context, int resource, List<Track> tracks) {
		super(context, resource, tracks);

		inflater = (LayoutInflater)context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
	}

	@Override
	public View getView(int position, View convertView, ViewGroup parent) {
		View view = convertView == null ? inflater.inflate(R.layout.result_list_item, null) : convertView;
		// Get the track information
		Track track = (Track) getItem(position);
		String name = track.getName();
		Artist artist = track.getArtists().get(0);

		// Bind UI elements
		TextView songTextView = (TextView) view.findViewById(R.id.song_text);
		TextView artistTextView = (TextView) view.findViewById(R.id.artist_text);

		// Update values
		songTextView.setText(name);
		artistTextView.setText(artist.getName());

		return view;
	}
}

{% endhighlight %}
{% highlight xml %}
<?xml version="1.0" encoding="utf-8"?>

<LinearLayout
android:layout_width="match_parent"
android:layout_height="match_parent"
android:orientation="vertical"
xmlns:android="http://schemas.android.com/apk/res/android">

<RelativeLayout
android:layout_width="fill_parent"
android:layout_height="wrap_content">
<TextView
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:textAppearance="?android:attr/textAppearanceLarge"
android:text="Midnatt"
android:id="@+id/song_text"/>
<TextView
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:textAppearance="?android:attr/textAppearanceMedium"
android:text="Oslo ess"
android:id="@+id/artist_text"
android:layout_below="@id/song_text"
/>
</RelativeLayout>
</LinearLayout>
{% endhighlight %}

<h3> ResultActivity</h3>
{% highlight java %}
public class ResultActivity extends Activity {
    ListView listView;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_result);

        listView = (ListView) findViewById(R.id.listView);

        try {
            // Get the track list from the MainActivity
            Bundle data = getIntent().getExtras();
            ObjectMapper mapper = new ObjectMapper();
            List<Track> tracks = Arrays.asList(mapper.readValue(data.getString("tracks"), Track[].class));

            listView.setAdapter(new TrackAdapter(this, R.layout.result_list_item, tracks));
            listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
                @Override
                public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                    // Get the clicked track
                    Track track = (Track) parent.getItemAtPosition(position);
                    // Start playback in Spotify
                    Intent appPlayBackIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(track.getHref()));
                    // Verify that the device has Spotify and can play the track
                    if (appPlayBackIntent.resolveActivity(getPackageManager()) != null) {
                        startActivity(appPlayBackIntent);
                    }
                    else {
                        // Open play store so that the user can download Spotify
                        String packageName = "com.spotify.mobile.android.ui";
                        try {
                            startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse("market://details?id=" + packageName)));
                        }
                        catch (android.content.ActivityNotFoundException anfe) {
                            startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse("http://play.google.com/store/apps/details?id=" + packageName)));
                        }
                    }
                }
            });
        } catch (IOException e) {
            // Do nothing
        }
    }
}
{% endhighlight %}
{% highlight java %}
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:paddingLeft="@dimen/activity_horizontal_margin"
    android:paddingRight="@dimen/activity_horizontal_margin"
    android:paddingTop="@dimen/activity_vertical_margin"
    android:paddingBottom="@dimen/activity_vertical_margin"
    android:background="@color/dark_gray"
    tools:context="no.bekk.spotifyapieksempel.ResultActivity">

    <ListView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:id="@+id/listView"/>
</RelativeLayout>

{% endhighlight %}
